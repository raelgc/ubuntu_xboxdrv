#xboxdrv Controller workers
# Shortcut variable
env DEFAULT="/etc/default/xboxdrv"

# States that this file is the blueprint for all controller jobs
instance $ID

script
    # Read configuration variable file if it is present
    if [ -f $DEFAULT ] ; then
        . $DEFAULT
    fi
    # This will store all system pad options from /etc/default/xboxdrv
    PAD_OPTIONS="--silent --dbus disabled --daemon"
    
    # Checking if user has enabled forcefeedback
    if [ "$FORCE_FEEDBACK" = true ] ; then
        PAD_OPTIONS="$PAD_OPTIONS --force-feedback"
    fi

    # Checking if user has enabled mimic_xpad
    if [ "$MIMIC_XPAD" = true ] ; then
        PAD_OPTIONS="$PAD_OPTIONS --mimic-xpad --mimic-xpad-wireless"
    fi
    # Adding --detache-kernel-driver
    PAD_OPTIONS="$PAD_OPTIONS --detach-kernel-driver"

    # Store our instance name, this is either an int from ubuntu-xboxdrv signifying
    # - the controller, or a product:vendor pair from a udev rule
    SLOT_ID="$ID"

    # If detected that udev rule launched this instance, determine which controller
    # - was connected
    if (( $( echo $SLOT_ID | wc -m ) > 5 )) ; then
        # Redefine slot number as the appropriate number
        SLOT_ID="$( grep CONTROLLER.=.$SLOT_ID $DEFAULT | cut -c 11 )"
    fi
    # Create arguemts for xboxdrv to identify process to controller
    INS_ARGS="--id $(($SLOT_ID-1)) --wid $(($SLOT_ID-1)) --led $(($SLOT_ID+1))"

    # Get the controller options for slot number $SLOT_ID, since it is now
    # - just the corresponding number
    M_CONTROLLER_OPTIONS="$( grep CONTROLLER$SLOT_ID.OPTIONS= $DEFAULT | cut -d '"' -f2 )"
    # Store all xboxdrv arguements
    ARGS="$XBOXDRV_OPTIONS $PAD_OPTIONS $INS_ARGS $M_CONTROLLER_OPTIONS"
    #start xboxdrv with appropriate arguements
    exec xboxdrv $ARGS
end script

#this is here to allow the addressing of a single job (ubuntu-xboxdrv)
stop on stopping ubuntu-xboxdrv
